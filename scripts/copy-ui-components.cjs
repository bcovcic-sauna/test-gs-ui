/**
 * Post-install script to copy UI components SOURCE files from gs-ui package
 * to local components/ui directory.
 * 
 * This ensures:
 * - Source .tsx/.ts files are available locally for imports
 * - The consuming app handles its own build/compilation
 * - AI tools can work with actual source code (not compiled JS)
 * - Required dependencies are added to the consuming app
 * - Modifications are overwritten on package updates
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const PACKAGE_NAME = '@bc-testing/gs-ui';
const PACKAGE_ROOT = path.join(__dirname, '..', 'node_modules', PACKAGE_NAME);
const PACKAGE_SRC = path.join(PACKAGE_ROOT, 'src');
const TARGET_DIR = path.join(__dirname, '..', 'components', 'ui');
const CONSUMER_PKG_PATH = path.join(__dirname, '..', 'package.json');

function copyFiles(src, dest) {
  if (!fs.existsSync(dest)) {
    fs.mkdirSync(dest, { recursive: true });
  }

  const entries = fs.readdirSync(src, { withFileTypes: true });
  const copiedFiles = [];

  for (const entry of entries) {
    const srcPath = path.join(src, entry.name);
    const destPath = path.join(dest, entry.name);

    if (entry.isDirectory()) {
      const subFiles = copyFiles(srcPath, destPath);
      copiedFiles.push(...subFiles);
    } else if (entry.name.endsWith('.tsx') || entry.name.endsWith('.ts')) {
      // Read file and fix imports
      let content = fs.readFileSync(srcPath, 'utf8');
      // Fix relative imports: ../utils/utils -> ./utils/utils
      content = content.replace(/from ["']\.\.\/utils\/utils["']/g, 'from "./utils/utils"');
      fs.writeFileSync(destPath, content);
      copiedFiles.push(entry.name);
    }
  }
  
  return copiedFiles;
}

function addDependencies() {
  // Read gs-ui package.json to get peer dependencies
  const gsUiPkgPath = path.join(PACKAGE_ROOT, 'package.json');
  if (!fs.existsSync(gsUiPkgPath)) {
    console.warn('   ‚ö†Ô∏è  Could not find gs-ui package.json');
    return false;
  }

  const gsUiPkg = JSON.parse(fs.readFileSync(gsUiPkgPath, 'utf8'));
  const peerDeps = gsUiPkg.peerDependencies || {};
  
  // Read consuming app's package.json
  const consumerPkg = JSON.parse(fs.readFileSync(CONSUMER_PKG_PATH, 'utf8'));
  consumerPkg.dependencies = consumerPkg.dependencies || {};
  
  // Find missing dependencies (exclude react/react-dom as they should already be there)
  const skipDeps = ['react', 'react-dom'];
  const missingDeps = [];
  
  for (const [dep, version] of Object.entries(peerDeps)) {
    if (skipDeps.includes(dep)) continue;
    if (!consumerPkg.dependencies[dep]) {
      consumerPkg.dependencies[dep] = version;
      missingDeps.push(dep);
    }
  }
  
  if (missingDeps.length > 0) {
    // Write updated package.json
    fs.writeFileSync(CONSUMER_PKG_PATH, JSON.stringify(consumerPkg, null, 2) + '\n');
    console.log(`   ‚úì Added ${missingDeps.length} dependencies to package.json`);
    return true; // Signal that npm install is needed
  }
  
  return false;
}

function main() {
  console.log(`üì¶ Copying UI component sources from ${PACKAGE_NAME}...`);

  // Check if package is installed
  if (!fs.existsSync(PACKAGE_SRC)) {
    console.warn(`‚ö†Ô∏è  Warning: ${PACKAGE_NAME}/src not found in node_modules.`);
    console.warn(`   Make sure the package includes 'src' in its 'files' field.`);
    console.warn(`   Run 'npm install ${PACKAGE_NAME}' first.`);
    return;
  }

  // Remove existing components/ui directory to ensure clean copy
  if (fs.existsSync(TARGET_DIR)) {
    console.log(`üóëÔ∏è  Removing existing components/ui directory...`);
    fs.rmSync(TARGET_DIR, { recursive: true, force: true });
  }

  console.log(`üìã Copying to ${path.relative(process.cwd(), TARGET_DIR)}...`);
  
  try {
    let totalFiles = 0;

    // 1. Copy component files from src/components/ directly into components/ui/
    const componentsDir = path.join(PACKAGE_SRC, 'components');
    if (fs.existsSync(componentsDir)) {
      const files = copyFiles(componentsDir, TARGET_DIR);
      totalFiles += files.length;
      console.log(`   ‚úì Copied ${files.length} component files (imports fixed)`);
    }

    // 2. Copy utils folder to components/ui/utils/
    const utilsDir = path.join(PACKAGE_SRC, 'utils');
    if (fs.existsSync(utilsDir)) {
      const utilsTarget = path.join(TARGET_DIR, 'utils');
      const files = copyFiles(utilsDir, utilsTarget);
      totalFiles += files.length;
      console.log(`   ‚úì Copied ${files.length} utility files`);
    }

    // 3. Create index.ts barrel file that exports all components
    const componentFiles = fs.readdirSync(TARGET_DIR)
      .filter(f => f.endsWith('.tsx') || (f.endsWith('.ts') && f !== 'index.ts'))
      .map(f => f.replace(/\.(tsx?|ts)$/, ''));
    
    const indexContent = `// Auto-generated by copy-ui-components.cjs
// Do not modify - this file is regenerated on each install

${componentFiles.map(name => `export * from './${name}';`).join('\n')}

// Utils
export * from './utils/utils';
`;
    
    fs.writeFileSync(path.join(TARGET_DIR, 'index.ts'), indexContent);
    console.log(`   ‚úì Created index.ts with ${componentFiles.length} exports`);
    
    // 4. Add required dependencies to consuming app
    const needsInstall = addDependencies();
    
    console.log(`‚úÖ Successfully copied ${totalFiles} source files!`);
    console.log(`   Components are now available at: ${path.relative(process.cwd(), TARGET_DIR)}`);
    console.log(`   Import example: import { Button } from '@/components/ui';`);
    console.log(`   ‚ö†Ô∏è  Note: Do not modify files in components/ui/`);
    console.log(`   They will be overwritten on package updates.`);
    
    if (needsInstall) {
      console.log(`\nüîÑ Dependencies were added to package.json.`);
      console.log(`   Run 'npm install' to install them.`);
    }
  } catch (error) {
    console.error(`‚ùå Error copying components:`, error);
    process.exit(1);
  }
}

main();
