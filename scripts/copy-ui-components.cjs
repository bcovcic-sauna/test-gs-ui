/**
 * Post-install script to copy UI components SOURCE files from gs-ui package
 * to local components/ui directory.
 * 
 * This ensures:
 * - Source .tsx/.ts files are available locally for imports
 * - The consuming app handles its own build/compilation
 * - AI tools can work with actual source code (not compiled JS)
 * - Required dependencies are added to the consuming app
 * - Modifications are overwritten on package updates
 */

const fs = require('fs');
const path = require('path');

const PACKAGE_NAME = '@bc-testing/gs-ui';
const PACKAGE_ROOT = path.join(__dirname, '..', 'node_modules', PACKAGE_NAME);
const PACKAGE_SRC = path.join(PACKAGE_ROOT, 'src');
const TARGET_DIR = path.join(__dirname, '..', 'components', 'ui');

function copyFiles(src, dest) {
  if (!fs.existsSync(dest)) {
    fs.mkdirSync(dest, { recursive: true });
  }

  const entries = fs.readdirSync(src, { withFileTypes: true });
  const copiedFiles = [];

  for (const entry of entries) {
    const srcPath = path.join(src, entry.name);
    const destPath = path.join(dest, entry.name);

    if (entry.isDirectory()) {
      const subFiles = copyFiles(srcPath, destPath);
      copiedFiles.push(...subFiles);
    } else if (entry.name.endsWith('.tsx') || entry.name.endsWith('.ts')) {
      // Read file and fix imports
      let content = fs.readFileSync(srcPath, 'utf8');
      // Fix relative imports: ../utils/utils -> ./utils/utils
      content = content.replace(/from ["']\.\.\/utils\/utils["']/g, 'from "./utils/utils"');
      fs.writeFileSync(destPath, content);
      copiedFiles.push(entry.name);
    }
  }
  
  return copiedFiles;
}

function main() {
  console.log(`üì¶ Copying UI component sources from ${PACKAGE_NAME}...`);

  // Check if package is installed
  if (!fs.existsSync(PACKAGE_SRC)) {
    console.warn(`‚ö†Ô∏è  Warning: ${PACKAGE_NAME}/src not found in node_modules.`);
    console.warn(`   Make sure the package includes 'src' in its 'files' field.`);
    console.warn(`   Run 'npm install ${PACKAGE_NAME}' first.`);
    return;
  }

  // Remove existing components/ui directory to ensure clean copy
  if (fs.existsSync(TARGET_DIR)) {
    console.log(`üóëÔ∏è  Removing existing components/ui directory...`);
    fs.rmSync(TARGET_DIR, { recursive: true, force: true });
  }

  console.log(`üìã Copying to ${path.relative(process.cwd(), TARGET_DIR)}...`);
  
  try {
    let totalFiles = 0;

    // 1. Copy component files from src/components/ directly into components/ui/
    const componentsDir = path.join(PACKAGE_SRC, 'components');
    if (fs.existsSync(componentsDir)) {
      const files = copyFiles(componentsDir, TARGET_DIR);
      totalFiles += files.length;
      console.log(`   ‚úì Copied ${files.length} component files (imports fixed)`);
    }

    // 2. Copy utils folder to components/ui/utils/
    const utilsDir = path.join(PACKAGE_SRC, 'utils');
    if (fs.existsSync(utilsDir)) {
      const utilsTarget = path.join(TARGET_DIR, 'utils');
      const files = copyFiles(utilsDir, utilsTarget);
      totalFiles += files.length;
      console.log(`   ‚úì Copied ${files.length} utility files`);
    }

    // 3. Create index.ts barrel file that exports all components
    const componentFiles = fs.readdirSync(TARGET_DIR)
      .filter(f => f.endsWith('.tsx') || (f.endsWith('.ts') && f !== 'index.ts'))
      .map(f => f.replace(/\.(tsx?|ts)$/, ''));
    
    const indexContent = `// Auto-generated by copy-ui-components.cjs
// Do not modify - this file is regenerated on each install

${componentFiles.map(name => `export * from './${name}';`).join('\n')}

// Utils
export * from './utils/utils';
`;
    
    fs.writeFileSync(path.join(TARGET_DIR, 'index.ts'), indexContent);
    console.log(`   ‚úì Created index.ts with ${componentFiles.length} exports`);

    console.log(`‚úÖ Successfully copied ${totalFiles} source files!`);
    console.log(`   Components are now available at: ${path.relative(process.cwd(), TARGET_DIR)}`);
    console.log(`   Import example: import { Button } from '@/components/ui';`);
    console.log(`   ‚ö†Ô∏è  Note: Do not modify files in components/ui/`);
    console.log(`   They will be overwritten on package updates.`);
    
  } catch (error) {
    console.error(`‚ùå Error copying components:`, error);
    process.exit(1);
  }
}

main();
